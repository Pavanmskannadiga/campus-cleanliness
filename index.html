<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Campus Cleanliness - AI Monitoring System</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 { color: #333; margin-bottom: 10px; font-size: 24px; }
    .subtitle { color: #666; margin-bottom: 20px; font-size: 14px; }
    .tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
      flex-wrap: wrap;
    }
    .tab {
      padding: 10px 16px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: #6b7280;
      transition: all 0.3s;
      font-size: 14px;
    }
    .tab:hover { color: #3b82f6; }
    .tab.active { color: #3b82f6; border-bottom-color: #3b82f6; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .btn-start { background: #10b981; color: white; }
    .btn-start:hover { background: #059669; transform: translateY(-2px); }
    .btn-stop { background: #ef4444; color: white; }
    .btn-stop:hover { background: #dc2626; }
    .btn-detect { background: #3b82f6; color: white; }
    .btn-detect:hover { background: #2563eb; }
    .btn-stop-detect { background: #f59e0b; color: white; }
    .btn-snapshot { background: #8b5cf6; color: white; }
    .btn-export { background: #06b6d4; color: white; }
    .btn-upload { background: #0ea5e9; color: white; }
    .btn-upload:hover { background: #0284c7; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .video-container {
      position: relative;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
      min-height: 300px;
    }
    video { width: 100%; height: auto; display: block; }
    canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    .status-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #10b981;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      z-index: 10;
    }
    .pulse {
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    .detection-info {
      background: linear-gradient(135deg, #fecaca 0%, #fef3c7 100%);
      border-left: 4px solid #ef4444;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .detection-info h3 { color: #991b1b; font-size: 16px; margin-bottom: 6px; }
    .detection-info p { color: #7c2d12; margin-bottom: 10px; font-size: 13px; }
    .btn-alert {
      background: #ef4444;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }
    .alerts-section {
      background: #f9fafb;
      padding: 15px;
      border-radius: 8px;
    }
    .alerts-section h3 { margin-bottom: 12px; color: #333; font-size: 16px; }
    .alert-item {
      background: white;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 8px;
      border-left: 4px solid #3b82f6;
      animation: slideIn 0.3s ease;
      font-size: 13px;
    }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
    .alert-item strong { color: #1e40af; }
    .no-camera {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      background: #1f2937;
      border-radius: 12px;
      color: white;
    }
    .no-camera svg { width: 48px; height: 48px; margin-bottom: 15px; opacity: 0.5; }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-value { font-size: 24px; font-weight: bold; margin-bottom: 3px; }
    .stat-label { font-size: 11px; opacity: 0.9; }
    .snapshots-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    .snapshot-item {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .snapshot-item img { width: 100%; height: auto; display: block; }
    .snapshot-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 6px;
      font-size: 10px;
    }
    .analytics-chart {
      background: #f9fafb;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .chart-bar { display: flex; align-items: center; margin-bottom: 10px; }
    .chart-label { width: 120px; font-weight: 600; font-size: 12px; }
    .chart-bar-fill {
      flex: 1;
      height: 25px;
      background: #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
    }
    .chart-bar-value {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6);
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
      color: white;
      font-weight: 600;
      font-size: 12px;
      min-width: 30px;
    }
    .heatmap { background: #f9fafb; padding: 15px; border-radius: 8px; }
    .heatmap-row { display: flex; align-items: center; margin-bottom: 10px; }
    .heatmap-label { width: 100px; font-weight: 600; font-size: 12px; }
    .heatmap-bar { flex: 1; height: 20px; background: #e5e7eb; border-radius: 10px; overflow: hidden; }
    .heatmap-fill { height: 100%; transition: width 0.5s ease; }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 12px 18px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideInRight 0.3s ease;
      z-index: 1000;
      max-width: 280px;
      font-size: 14px;
    }
    @keyframes slideInRight { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
    .trend-chart { width: 100%; height: 150px; background: #f0f0f0; border-radius: 8px; position: relative; }
    .trend-bars { display: flex; align-items: flex-end; height: 120px; padding: 10px; gap: 2px; }
    .trend-bar { flex: 1; background: linear-gradient(180deg, #3b82f6, #8b5cf6); border-radius: 3px 3px 0 0; min-height: 5px; transition: height 0.3s; }
    .trend-labels { display: flex; justify-content: space-between; padding: 0 10px; font-size: 10px; color: #666; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé• Campus Cleanliness - AI Monitoring System</h1>
    <p class="subtitle">Real-time AI detection ‚Ä¢ Live analytics ‚Ä¢ Smart alerts</p>
    
    <div class="tabs">
      <button class="tab active" data-tab="camera">üìπ Live Camera</button>
      <button class="tab" data-tab="snapshots">üì∏ Snapshots</button>
      <button class="tab" data-tab="analytics">üìä Analytics</button>
      <button class="tab" data-tab="heatmap">üó∫ Heatmap</button>
    </div>
    
    <div id="cameraTab" class="tab-content active">
      <div class="stats">
        <div class="stat-card">
          <div class="stat-value" id="detectionsCount">0</div>
          <div class="stat-label">Detections</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="alertsCount">0</div>
          <div class="stat-label">Alerts</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="confidenceAvg">0%</div>
          <div class="stat-label">Avg Confidence</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="snapshotsCount">0</div>
          <div class="stat-label">Snapshots</div>
        </div>
      </div>
      
      <div class="controls">
        <button id="startBtn" class="btn-start">üìπ Start Camera</button>
        <button id="stopBtn" class="btn-stop" style="display:none;">‚èπ Stop</button>
        <button id="detectBtn" class="btn-detect" style="display:none;">ü§ñ Start Detection</button>
        <button id="stopDetectBtn" class="btn-stop-detect" style="display:none;">‚è∏ Pause</button>
        <button id="snapshotBtn" class="btn-snapshot" style="display:none;">üì∏ Snapshot</button>

        <!-- NEW: upload image for analysis -->
        <button id="uploadBtn" class="btn-upload">üì§ Upload & Analyse</button>
        <input id="uploadInput" type="file" accept="image/*" style="display:none;" />

        <button id="exportBtn" class="btn-export">üì• Export</button>
      </div>
      
      <div class="video-container">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <div id="statusBadge" class="status-badge" style="display:none;">
          <span class="pulse"></span>
          <span>AI Active</span>
        </div>
        <div id="noCamera" class="no-camera">
          <svg fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
          </svg>
          <h3>Camera is Off</h3>
          <p style="font-size:14px;">Click "Start Camera" to begin</p>
        </div>
      </div>
      
      <div id="detectionInfo" class="detection-info" style="display:none;"></div>
      
      <div class="alerts-section">
        <h3>üö® Generated Alerts</h3>
        <div id="alertsList">
          <p style="color:#666; font-size:13px;">No alerts yet. Start detection or upload an image to generate alerts.</p>
        </div>
      </div>
    </div>
    
    <div id="snapshotsTab" class="tab-content">
      <h3 style="margin-bottom:10px;">üì∏ Captured Snapshots</h3>
      <div id="snapshotsGrid" class="snapshots-grid">
        <p style="color:#666; font-size:13px;">No snapshots yet.</p>
      </div>
    </div>
    
    <div id="analyticsTab" class="tab-content">
      <h3 style="margin-bottom:15px;">üìä Detection Analytics</h3>
      <div class="analytics-chart">
        <h4 style="margin-bottom:12px; font-size:14px;">Detection Types</h4>
        <div id="analyticsChart"><p style="color:#666; font-size:13px;">No data yet.</p></div>
      </div>
      <div class="analytics-chart">
        <h4 style="margin-bottom:12px; font-size:14px;">Hourly Trend</h4>
        <div class="trend-chart">
          <div class="trend-bars" id="trendBars"></div>
          <div class="trend-labels"><span>0h</span><span>6h</span><span>12h</span><span>18h</span><span>24h</span></div>
        </div>
      </div>
    </div>
    
    <div id="heatmapTab" class="tab-content">
      <h3 style="margin-bottom:15px;">üó∫ Campus Cleanliness Heatmap</h3>
      <div class="heatmap" id="heatmapContent"></div>
    </div>
  </div>
  
  <div id="notification" class="notification" style="display:none;"></div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const detectBtn = document.getElementById('detectBtn');
    const stopDetectBtn = document.getElementById('stopDetectBtn');
    const snapshotBtn = document.getElementById('snapshotBtn');
    const exportBtn = document.getElementById('exportBtn');
    const statusBadge = document.getElementById('statusBadge');
    const noCamera = document.getElementById('noCamera');
    const detectionInfo = document.getElementById('detectionInfo');
    const alertsList = document.getElementById('alertsList');
    const notification = document.getElementById('notification');

    const uploadBtn = document.getElementById('uploadBtn');
    const uploadInput = document.getElementById('uploadInput');
    
    let stream = null;
    let detectionInterval = null;
    let detectionCount = 0;
    let alertCount = 0;
    let confidenceSum = 0;
    let snapshotsCount = 0;
    let detectionTypes = {};
    let snapshots = [];
    let hourlyData = new Array(24).fill(0);
    let alerts = [];

    // === API CONFIG ===
    // LOCAL:
    const API_BASE = 'http://127.0.0.1:5000';
    // RENDER (uncomment & change when deployed):
    // const API_BASE = 'https://your-render-service.onrender.com';

    const API_URL = API_BASE + '/api/detect_and_report';
    const ANALYTICS_URL = API_BASE + '/api/get_reports';

    // Heatmap sample data (used when backend returns no data)
    const initialHeatmapData = [
      { location: 'Library', score: 100 },
      { location: 'Cafeteria', score: 100 },
      { location: 'Dormitories', score: 100 },
      { location: 'Sports Complex', score: 100 },
      { location: 'Parking Lots', score: 100 }
    ];

    function showNotification(msg) {
      notification.textContent = msg;
      notification.style.display = 'block';
      setTimeout(() => { notification.style.display = 'none'; }, 2500);
    }

    function initTrendBars() {
      const container = document.getElementById('trendBars');
      container.innerHTML = hourlyData
        .map((_, i) => `<div class="trend-bar" data-hour="${i}" style="height:5px;"></div>`)
        .join('');
    }
    initTrendBars();

    function updateHeatmap(data) {
      const container = document.getElementById('heatmapContent');
      if (!data || data.length === 0) data = initialHeatmapData;

      const getScoreColor = (score) => {
        if (score >= 80) return '#10b981';
        if (score >= 60) return '#f59e0b';
        return '#ef4444';
      };

      container.innerHTML = data.map(item => {
        const scoreColor = getScoreColor(item.score);
        const value = item.score;
        return `
          <div class="heatmap-row">
            <div class="heatmap-label">${item.location}</div>
            <div class="heatmap-bar">
              <div class="heatmap-fill" style="width:${value}%; background:${scoreColor};"></div>
            </div>
            <span style="margin-left:10px; font-weight:bold; font-size:12px;">${value}</span>
          </div>
        `;
      }).join('');
    }
    updateHeatmap(initialHeatmapData);

    window.createAlert = function(type, confidence) {
      alertCount++;
      const time = new Date().toLocaleTimeString();
      alerts.unshift({ id: alertCount, type, confidence, time });
      
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert-item';
      alertDiv.innerHTML = `<strong>Alert #${alertCount}:</strong> ${type}<br><small>Confidence: ${confidence}% | Time: ${time}</small>`;
      
      if (alertsList.children[0]?.tagName === 'P') alertsList.innerHTML = '';
      alertsList.insertBefore(alertDiv, alertsList.firstChild);
      while (alertsList.children.length > 8) alertsList.removeChild(alertsList.lastChild);
      
      document.getElementById('alertsCount').textContent = alertCount;
      showNotification('üö® Alert created!');
    };

    function updateAnalytics() {
      const chart = document.getElementById('analyticsChart');
      const totalDetections = parseFloat(document.getElementById('detectionsCount').textContent) || 0;

      if (Object.keys(detectionTypes).length === 0 || totalDetections === 0) {
        chart.innerHTML = '<p style="color:#666; font-size:13px;">No data yet. Start detection or upload an image first.</p>';
        return;
      }
      chart.innerHTML = Object.entries(detectionTypes).map(([type, count]) => {
        const pct = (count / totalDetections * 100).toFixed(1);
        return `
          <div class="chart-bar">
            <div class="chart-label">${type}</div>
            <div class="chart-bar-fill">
              <div class="chart-bar-value" style="width:${Math.max(parseFloat(pct), 10)}%;">${count}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function updateTrendBars() {
      const maxVal = Math.max(...hourlyData, 1);
      document.querySelectorAll('.trend-bar').forEach((bar, i) => {
        const h = Math.max((hourlyData[i] / maxVal) * 100, 5);
        bar.style.height = h + 'px';
      });
    }

    function updateSnapshotsGrid() {
      const grid = document.getElementById('snapshotsGrid');
      if (snapshots.length === 0) {
        grid.innerHTML = '<p style="color:#666; font-size:13px;">No snapshots yet.</p>';
        return;
      }
      grid.innerHTML = snapshots.slice(0, 12).map((snap, i) => `
        <div class="snapshot-item">
          <img src="${snap.url}" alt="Snapshot ${i + 1}">
          <div class="snapshot-info">${snap.timestamp}</div>
        </div>
      `).join('');
    }

    async function fetchAnalyticsData() {
      try {
        const response = await fetch(ANALYTICS_URL);
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        
        const reportData = await response.json();
        
        hourlyData = reportData.hourlyData || new Array(24).fill(0);
        detectionTypes = reportData.detectionTypes || {};
        
        document.getElementById('detectionsCount').textContent = reportData.summary.totalDetections;
        document.getElementById('confidenceAvg').textContent = reportData.summary.avgConfidence;
        document.getElementById('alertsCount').textContent = reportData.summary.totalAlerts;

        updateTrendBars();
        updateAnalytics();
        updateHeatmap(reportData.heatmapData);
        
      } catch (error) {
        console.error("Failed to fetch analytics data:", error);
        showNotification('‚ùå Failed to load Analytics data from server.');
      }
    }

    function detectObjects() {
      if (video.readyState !== video.HAVE_ENOUGH_DATA) return;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      canvas.toBlob(async (blob) => {
        if (!blob) return;

        const formData = new FormData();
        formData.append('image', blob, 'frame.jpeg');
        formData.append('location_id', 'CAM_FRONT_DOOR'); 

        try {
          const response = await fetch(API_URL, {
            method: 'POST',
            body: formData,
          });

          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          
          const results = await response.json();
          
          if (results.success) {
            const detection = {
              type: results.detection_type,
              severity: results.is_alert ? 'high' : 'medium',
              confidence: results.confidence,
              color: results.is_alert ? '#ef4444' : '#f59e0b' 
            };
            
            const x = Math.random() * (canvas.width - 150) + 30;
            const y = Math.random() * (canvas.height - 100) + 40;
            const w = 140, h = 90;
            
            ctx.strokeStyle = detection.color;
            ctx.lineWidth = 3;
            ctx.strokeRect(x, y, w, h);
            ctx.fillStyle = detection.color;
            ctx.fillRect(x, y - 22, w, 22);
            ctx.fillStyle = 'white';
            ctx.font = 'bold 11px Arial';
            ctx.fillText(detection.type + ' ' + detection.confidence + '%', x + 5, y - 6);
            
            detectionCount++;
            confidenceSum += parseFloat(detection.confidence);
            
            detectionInfo.style.display = 'block';
            detectionInfo.innerHTML = `
              <h3>‚ö† ${detection.type}</h3>
              <p><strong>Confidence:</strong> ${detection.confidence}% | <strong>Severity:</strong> ${detection.severity} | <strong>Time:</strong> ${new Date().toLocaleTimeString()}</p>
              <button class="btn-alert" onclick="createAlert('${detection.type}', '${detection.confidence}')">üö® Create Alert</button>
            `;
            
            if (results.is_alert) {
              createAlert(detection.type, detection.confidence);
            }
          } else {
            detectionInfo.style.display = 'none';
          }

        } catch (error) {
          console.error('API Error:', error);
          showNotification('‚ùå API Connection Error!');
        }
      }, 'image/jpeg', 0.8); 
    }

    // Upload & analyse static image
    uploadBtn.addEventListener('click', () => {
      uploadInput.click();
    });

    uploadInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('image', file);
      formData.append('location_id', 'MANUAL_UPLOAD'); 

      showNotification('üì§ Uploading image for analysis...');

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: formData,
        });

        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

        const results = await response.json();

        if (results.success) {
          const detection = {
            type: results.detection_type,
            severity: results.is_alert ? 'high' : 'medium',
            confidence: results.confidence
          };

          detectionCount++;
          confidenceSum += parseFloat(detection.confidence);

          detectionInfo.style.display = 'block';
          detectionInfo.innerHTML = `
            <h3>üñº Uploaded Image ‚Ä¢ ${detection.type}</h3>
            <p><strong>Confidence:</strong> ${detection.confidence}% | <strong>Severity:</strong> ${detection.severity} | <strong>Location:</strong> MANUAL_UPLOAD | <strong>Time:</strong> ${new Date().toLocaleTimeString()}</p>
            <button class="btn-alert" onclick="createAlert('${detection.type}', '${detection.confidence}')">üö® Create Alert</button>
          `;

          document.getElementById('detectionsCount').textContent = detectionCount;
          document.getElementById('confidenceAvg').textContent = (confidenceSum / detectionCount).toFixed(1) + '%';

          const reader = new FileReader();
          reader.onload = function(ev) {
            snapshots.unshift({
              url: ev.target.result,
              timestamp: 'Uploaded ‚Ä¢ ' + new Date().toLocaleString(),
              id: Date.now()
            });
            snapshotsCount++;
            document.getElementById('snapshotsCount').textContent = snapshotsCount;
            updateSnapshotsGrid();
          };
          reader.readAsDataURL(file);

          showNotification('‚úÖ Image analysed successfully!');
        } else {
          detectionInfo.style.display = 'none';
          showNotification('‚ö† Analysis failed on server.');
        }

      } catch (err) {
        console.error('Upload API error:', err);
        showNotification('‚ùå Failed to analyse uploaded image.');
      } finally {
        uploadInput.value = '';
      }
    });

    // Camera controls
    startBtn.addEventListener('click', async () => {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: 'user' } 
        });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          video.play();
          noCamera.style.display = 'none';
          startBtn.style.display = 'none';
          stopBtn.style.display = 'inline-flex';
          detectBtn.style.display = 'inline-flex';
          snapshotBtn.style.display = 'inline-flex';
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          showNotification('‚úÖ Camera started!');
        };
      } catch (error) {
        showNotification('‚ùå Camera access denied!');
        console.error('Camera error:', error);
      }
    });

    stopBtn.addEventListener('click', () => {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        clearInterval(detectionInterval);
        noCamera.style.display = 'flex';
        startBtn.style.display = 'inline-flex';
        stopBtn.style.display = 'none';
        detectBtn.style.display = 'none';
        stopDetectBtn.style.display = 'none';
        snapshotBtn.style.display = 'none';
        statusBadge.style.display = 'none';
        detectionInfo.style.display = 'none';
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        showNotification('‚èπ Camera stopped');
      }
    });

    detectBtn.addEventListener('click', () => {
      detectBtn.style.display = 'none';
      stopDetectBtn.style.display = 'inline-flex';
      statusBadge.style.display = 'flex';
      detectionInterval = setInterval(detectObjects, 2000);
      showNotification('ü§ñ AI Detection started!');
    });

    stopDetectBtn.addEventListener('click', () => {
      clearInterval(detectionInterval);
      stopDetectBtn.style.display = 'none';
      detectBtn.style.display = 'inline-flex';
      statusBadge.style.display = 'none';
      detectionInfo.style.display = 'none';
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      showNotification('‚è∏ Detection paused');
    });

    snapshotBtn.addEventListener('click', () => {
      if (!video.srcObject || video.readyState < video.HAVE_ENOUGH_DATA) {
        showNotification('‚ùå Camera not ready!');
        return;
      }
      
      const snapshotCanvas = document.createElement('canvas');
      snapshotCanvas.width = video.videoWidth || 640;
      snapshotCanvas.height = video.videoHeight || 480;
      const snapshotCtx = snapshotCanvas.getContext('2d');
      
      snapshotCtx.drawImage(video, 0, 0, snapshotCanvas.width, snapshotCanvas.height);
      if (canvas.width > 0 && canvas.height > 0) {
        snapshotCtx.drawImage(canvas, 0, 0, snapshotCanvas.width, snapshotCanvas.height);
      }
      
      try {
        const dataUrl = snapshotCanvas.toDataURL('image/jpeg', 0.8);
        const timestamp = new Date().toLocaleString();
        
        snapshots.unshift({ url: dataUrl, timestamp: timestamp, id: Date.now() });
        snapshotsCount++;
        document.getElementById('snapshotsCount').textContent = snapshotsCount;
        updateSnapshotsGrid();
        showNotification('üì∏ Snapshot captured!');
      } catch (e) {
        console.error('Snapshot error:', e);
        showNotification('‚ùå Failed to capture!');
      }
    });

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
        
        if (tab.dataset.tab === 'analytics' || tab.dataset.tab === 'heatmap') {
          fetchAnalyticsData();
        }
        if (tab.dataset.tab === 'analytics') updateAnalytics();
      });
    });

    // Initial analytics fetch (safe even if backend returns demo data)
    fetchAnalyticsData();

    // Export report (front-end summary)
    exportBtn.addEventListener('click', () => {
      const report = {
        generatedAt: new Date().toISOString(),
        summary: {
          totalDetections: detectionCount,
          totalAlerts: alertCount,
          avgConfidence: detectionCount > 0 ? (confidenceSum / detectionCount).toFixed(1) + '%' : '0%',
          snapshotsTaken: snapshotsCount
        },
        detectionTypes,
        hourlyData,
        recentAlerts: alerts.slice(0, 10)
      };
      
      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'campus-cleanliness-report-' + Date.now() + '.json';
      a.click();
      URL.revokeObjectURL(url);
      showNotification('üì• Report exported!');
    });
  </script>
</body>
</html>
